/*! jQuery Pixel Select - v0.5.5 - 2013-06-18
* https://github.com/Bahlor/jQuery-Pixel-Related-Object-Selection
* Copyright (c) 2013 Christian Weber; Licensed MIT */
(function(e,t,i,s){"use strict";function a(t,i){this.element=t,this.options=e.extend({},h,i),this._defaults=h,this._name=r,this.pixelmap=[],this.image=new Image,this.ctx=null,this.init()}var n={},r="Pixelselect",h={over:null,out:null,click:null,ready:null,type:"img",precalc:!0,sublayers:!1,maxsubs:5,tolerance:40,debug:!1};a.prototype={init:function(){var t=i.createElement("canvas");return t.getContext?(e(this.element).data("precalc")!==s&&(this.options.precalc=e(this.element).data("precalc")===!0?!0:!1),e(this.element).data("sublayers")!==s&&(this.options.sublayers=e(this.element).data("sublayers")===!0?!0:!1),e(this.element).data("tolerance")!==s&&parseInt(e(this.element).data("tolerance"),null)>=0&&(this.options.tolerance=parseInt(e(this.element).data("tolerance"),null)),e(this.element).data("maxsubs")!==s&&parseInt(e(this.element).data("maxsubs"),null)>=0&&(this.options.maxsubs=parseInt(e(this.element).data("maxsubs"),null)),this.checkSrcType(),s):(n.log("Error: browser does not support canvas"),s)},checkSrcType:function(){var t=e(this.element);t.attr("src")!==s&&""!==t.attr("src")?this.image.src=t.attr("src"):t.data("img")&&t.data("img").length>4?this.image.src=t.data("img"):t.css("background-image")&&""!==t.css("background-image")&&(this.options.type="bg",this.image.src=t.css("background-image").replace("url(","").replace(")","")),""!==this.image.src&&(this.image.onload=this.generatePixelMap())},getCanvasRenderer:function(){var t=i.createElement("canvas");t.width=this.image.width,t.height=this.image.height;var s=t.getContext("2d");return s.drawImage(this.image,0,0),this.options.debug===!0&&e(t).appendTo("body"),s},generatePixelMap:function(){if(!this.image.complete){var t=this;return setTimeout(function(){t.generatePixelMap()},500),s}if(this.ctx=this.getCanvasRenderer(),this.options.precalc===!0){for(var i=(new Date).getTime(),a=0;this.image.width>a;a++)for(var r=0;this.image.height>r;r++){var h=this.ctx.getImageData(a,r,1,1);h.data[3]>this.options.tolerance&&(this.pixelmap[a]===s&&(this.pixelmap[a]=[]),this.pixelmap[a][r]=!0)}var o=(new Date).getTime();this.options.debug===!0&&n.log("Pixel map of "+this.image.src+" generated in "+(o-i)+" ms")}null!==this.options.ready&&this.options.ready(e(this.element)),this.attachEvents()},checkPixel:function(t,i){var a=e(this.element).offset();if(t-=a.left,i-=a.top,this.options.precalc===!0)return this.pixelmap[t]!==s&&this.pixelmap[t][i]!==s&&this.pixelmap[t][i]===!0?!0:!1;if(t===s||0>=t||i===s||0>=i||t>this.image.width||i>this.image.height)return!1;var n=this.ctx.getImageData(t,i,1,1);return n.data[3]>this.options.tolerance?!0:!1},checkSubLayers:function(t,a,n,r){e(this.element).hide();for(var h=[],o=!1,c=0;o===!1;){var l=i.elementFromPoint(t,a),u=e(l).triggerHandler("subcheck",[t,a]);u!==s&&(o=u,h.push(l)),o!==!0&&c>=this.options.maxsubs&&(o=!0),c++}h.length>0&&e(h[h.length-1]).trigger(r,[t,a]),e(this.element).show()},subcheckSubLayers:function(t,a,n){var r=this.checkPixel(a,n);if(r===!1)return!1;e(this.element).hide();var h=i.elementFromPoint(a,n),o=e(h).triggerHandler("subcheck",[a,n]);return e(this.element).show(),o!==s&&o!==!1?!0:!1},attachEvents:function(){var t=e(this.element),i=this;t.on("click",function(e,t,s){i._click(e,t,s)}),t.on("mousemove",function(e,t,s){i._over(e,t,s)}),t.on("mouseout",function(e,t,s){i._out(e,t,s)}),t.on("subcheck",function(e,t,s){return i.subcheckSubLayers(e,t,s)})},_click:function(t,i,a){n.log(this.image.src+" was clicked",t);var r=r===s?t.pageX:i,h=h===s?t.pageY:a,o=this.checkPixel(r,h,t);o!==!0&&this.options.sublayers===!0&&this.checkSubLayers(r,h,t,"click"),null!==this.options.click&&this.options.click(t,e(this.element),o),t.preventDefault()},_over:function(t,i,a){var n=n===s?t.pageX:i,r=r===s?t.pageY:a,h=this.checkPixel(n,r,t);h!==!0&&this.options.sublayers===!0&&this.checkSubLayers(n,r,t,"mousemove"),null!==this.options.over&&this.options.over(t,e(this.element),h),t.preventDefault()},_out:function(t,i,a){var n=n===s?t.pageX:i,r=r===s?t.pageY:a,h=this.checkPixel(n,r,t);h!==!0&&this.options.sublayers===!0&&this.checkSubLayers(n,r,t,"mouseout"),null!==this.options.out&&this.options.out(t,e(this.element),h),t.preventDefault()}},e.fn[r]=function(t){return this.each(function(){e.data(this,"plugin_"+r)||e.data(this,"plugin_"+r,new a(this,t))})}})(jQuery,window,document);