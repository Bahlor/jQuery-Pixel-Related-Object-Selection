(function(e,c,a,g){var d="pixelselect";var f={over:null,out:null,click:null,ready:null,type:"img",precalc:true,sublayers:false,maxsubs:5,tolerance:40,debug:false};function b(i,h){this.element=i;this.options=e.extend({},f,h);this._defaults=f;this._name=d;this.pixelmap=[];this.image=new Image();this.ctx=null;this.init()}b.prototype={init:function(){var h=a.createElement("canvas");if(!h.getContext){console.log("Error: browser does not support canvas");return}if(e(this.element).data("precalc")!==g){this.options.precalc=(e(this.element).data("precalc")==true)?true:false}if(e(this.element).data("sublayers")!==g){this.options.sublayers=(e(this.element).data("sublayers")==true)?true:false}if(e(this.element).data("tolerance")!==g&&parseInt(e(this.element).data("tolerance"))>=0){this.options.tolerance=parseInt(e(this.element).data("tolerance"))}if(e(this.element).data("maxsubs")!==g&&parseInt(e(this.element).data("maxsubs"))>=0){this.options.maxsubs=parseInt(e(this.element).data("maxsubs"))}this.checkSrcType()},checkSrcType:function(){var h=e(this.element);if(h.attr("src")!==g&&h.attr("src")!=""){this.image.src=h.attr("src")}else{if(h.data("img")&&h.data("img").length>4){this.image.src=h.data("img")}else{if(h.css("background-image")&&h.css("background-image")!=""){this.options.type="bg";this.image.src=h.css("background-image").replace("url(","").replace(")","")}}}if(this.image.src!=""){this.image.onload=this.generatePixelMap()}},getCanvasRenderer:function(){var i=a.createElement("canvas");i.width=this.image.width;i.height=this.image.height;var h=i.getContext("2d");h.drawImage(this.image,0,0);if(this.options.debug===true){e(i).appendTo("body")}return h},generatePixelMap:function(){if(!this.image.complete){var m=this;setTimeout(function(){m.generatePixelMap()},500);return}this.ctx=this.getCanvasRenderer();if(this.options.precalc==true){var j=(new Date).getTime();for(var h=0;h<this.image.width;h++){for(var l=0;l<this.image.height;l++){var k=this.ctx.getImageData(h,l,1,1);if(k.data[3]>this.options.tolerance){if(this.pixelmap[h]==g){this.pixelmap[h]=[]}this.pixelmap[h][l]=true}}}var i=(new Date).getTime();if(this.options.debug===true){console.log("Pixel map of "+this.image.src+" generated in "+(i-j)+" ms")}}this.options.ready(e(this.element));this.attachEvents()},checkPixel:function(h,k){var j=e(this.element).offset();h=h-j.left,k=k-j.top;if(this.options.precalc==true){return(this.pixelmap[h]!==g&&this.pixelmap[h][k]!==g&&this.pixelmap[h][k]==true)?true:false}else{if(h===g||h<=0||k===g||k<=0||h>this.image.width||k>this.image.height){return false}var i=this.ctx.getImageData(h,k,1,1);return(i.data[3]>this.options.tolerance)?true:false}},checkSubLayers:function(p,n,o,i){e(this.element).hide();var m=[],h=false,l=0;while(h===false){var j=a.elementFromPoint(p,n);var k=e(j).triggerHandler("subcheck",[p,n]);if(k!==g){h=k;m.push(j)}if(h!==true&&l>=this.options.maxsubs){h=true}l++}if(m.length>0){e(m[m.length-1]).trigger(i,[p,n])}e(this.element).show()},subcheckSubLayers:function(i,h,m){var l=this.checkPixel(h,m);if(l==false){return false}e(this.element).hide();var k=a.elementFromPoint(h,m),j=e(k).triggerHandler("subcheck",[h,m]);e(this.element).show();return(j!==g&&j!==false)?true:false},attachEvents:function(){var h=e(this.element),i=this;h.on("click",function(k,j,l){i._click(k,j,l)});h.on("mousemove",function(k,j,l){i._over(k,j,l)});h.on("mouseout",function(k,j,l){i._out(k,j,l)});h.on("subcheck",function(k,j,l){return i.subcheckSubLayers(k,j,l)})},_click:function(i,h,k){console.log(this.image.src+" was clicked",i);var h=(h===g)?i.pageX:h,k=(k===g)?i.pageY:k,j=this.checkPixel(h,k,i);if(j!=true&&this.options.sublayers==true){this.checkSubLayers(h,k,i,"click")}this.options.click(i,e(this.element),j);i.preventDefault()},_over:function(i,h,k){var h=(h===g)?i.pageX:h,k=(k===g)?i.pageY:k,j=this.checkPixel(h,k,i);if(j!=true&&this.options.sublayers==true){this.checkSubLayers(h,k,i,"mousemove")}this.options.over(i,e(this.element),j);i.preventDefault()},_out:function(i,h,k){var h=(h===g)?i.pageX:h,k=(k===g)?i.pageY:k,j=this.checkPixel(h,k,i);if(j!=true&&this.options.sublayers==true){this.checkSubLayers(h,k,i,"mouseout")}this.options.out(i,e(this.element),j);i.preventDefault()}};e.fn[d]=function(h){return this.each(function(){if(!e.data(this,"plugin_"+d)){e.data(this,"plugin_"+d,new b(this,h))}})}})(jQuery,window,document);
