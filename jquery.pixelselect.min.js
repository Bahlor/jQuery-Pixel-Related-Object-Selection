(function(e,t,n,r){"use strict";function o(t,n){this.element=t;this.options=e.extend({},s,n);this._defaults=s;this._name=i;this.pixelmap=[];this.image=new Image;this.ctx=null;this.init()}var i="pixelselect";var s={over:null,out:null,click:null,ready:null,type:"img",precalc:true,sublayers:false,tolerance:40,debug:false};o.prototype={init:function(){var t=n.createElement("canvas");if(!t.getContext){console.log("Error: browser does not support canvas");return}if(e(this.element).data("precalc")!==r){this.options["precalc"]=e(this.element).data("precalc")==true?true:false}if(e(this.element).data("sublayers")!==r){this.options["sublayers"]=e(this.element).data("sublayers")==true?true:false}if(e(this.element).data("tolerance")!==r&&parseInt(e(this.element).data("tolerance"))>=0){this.options["tolerance"]=parseInt(e(this.element).data("tolerance"))}this.checkSrcType()},checkSrcType:function(){var t=e(this.element);if(t.attr("src")!==r&&t.attr("src")!=""){console.log("image");this.image.src=t.attr("src")}else{if(t.data("img")&&t.data("img").length>4){console.log("image /data");this.image.src=t.data("img")}else{if(t.css("background-image")&&t.css("background-image")!=""){console.log("bg image");this.options["type"]="bg";this.image.src=t.css("background-image").replace("url(","").replace(")","")}}}if(this.image.src!=""){this.image.onload=this.generatePixelMap()}},getCanvasRenderer:function(){var t=n.createElement("canvas");t.width=this.image.width;t.height=this.image.height;var r=t.getContext("2d");r.drawImage(this.image,0,0);if(this.options["debug"]===true){e(t).appendTo("body")}return r},generatePixelMap:function(){if(!this.image.complete){var t=this;setTimeout(function(){t.generatePixelMap()},500);return}this.ctx=this.getCanvasRenderer();if(this.options["precalc"]==true){var n=(new Date).getTime();for(var i=0;i<this.image.width;i++){for(var s=0;s<this.image.height;s++){var o=this.ctx.getImageData(i,s,1,1);if(o.data[3]>this.options["tolerance"]){if(this.pixelmap[i]==r){this.pixelmap[i]=[]}this.pixelmap[i][s]=true}}}var u=(new Date).getTime();if(this.options["debug"]===true){console.log("Pixel map of "+this.image.src+" generated in "+(u-n)+" ms")}}this.options["ready"](e(this.element));this.attachEvents()},checkPixel:function(t,n){var i=e(this.element).offset();t=t-i.left,n=n-i.top;if(this.options["precalc"]==true){return this.pixelmap[t]!==r&&this.pixelmap[t][n]!==r&&this.pixelmap[t][n]==true?true:false}else{if(t===r||t<=0||n===r||n<=0||t>this.image.width||n>this.image.height){return false}var s=this.ctx.getImageData(t,n,1,1);return s.data[3]>this.options["tolerance"]?true:false}},checkSubLayers:function(t,i,s,o){e(this.element).hide();var u=n.elementFromPoint(t,i);e(this.element).show();if(u!=""&&typeof u!==r){this.options["out"](s,e(this.element),false);e(u).trigger(o,[s.pageX,s.pageY])}},attachEvents:function(){var t=e(this.element),n=this;t.on("click",function(e,t,r){n._click(e,t,r)});t.on("mousemove",function(e,t,r){n._over(e,t,r)});t.on("mouseout",function(e,t,r){n._out(e,t,r)})},_click:function(t,n,i){console.log(this.image.src+" was clicked",t);var n=n===r?t.pageX:n,i=i===r?t.pageY:i,s=this.checkPixel(n,i,t);if(s!=true&&this.options["sublayers"]==true){this.checkSubLayers(n,i,t,"click")}this.options["click"](t,e(this.element),s);t.preventDefault()},_over:function(t,n,i){var n=n===r?t.pageX:n,i=i===r?t.pageY:i,s=this.checkPixel(n,i,t);if(s!=true&&this.options["sublayers"]==true){this.checkSubLayers(n,i,t,"mousemove")}this.options["over"](t,e(this.element),s);t.preventDefault()},_out:function(t,n,i){var n=n===r?t.pageX:n,i=i===r?t.pageY:i,s=this.checkPixel(n,i,t);if(s!=true&&this.options["sublayers"]==true){this.checkSubLayers(n,i,t,"mouseout")}this.options["out"](t,e(this.element),s);t.preventDefault()}};e.fn[i]=function(t){return this.each(function(){if(!e.data(this,"plugin_"+i)){e.data(this,"plugin_"+i,new o(this,t))}})}})(jQuery,window,document)
